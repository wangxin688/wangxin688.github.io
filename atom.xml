<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://wangxin688.github.io</id>
    <title>Jeffry&apos;s Blog</title>
    <updated>2022-05-20T14:34:06.808Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://wangxin688.github.io"/>
    <link rel="self" href="https://wangxin688.github.io/atom.xml"/>
    <subtitle>ç½‘ç»œå·¥ç¨‹å¸ˆå¼€å‘ä¹‹è·¯</subtitle>
    <logo>https://wangxin688.github.io/images/avatar.png</logo>
    <icon>https://wangxin688.github.io/favicon.ico</icon>
    <rights>All rights reserved 2022, Jeffry&apos;s Blog</rights>
    <entry>
        <title type="html"><![CDATA[NetDevOps-å·¥ç¨‹å®è·µ-è„šæ‰‹æ¶ç¯‡]]></title>
        <id>https://wangxin688.github.io/post/netdevops-gong-cheng-shi-jian-jiao-shou-jia-pian/</id>
        <link href="https://wangxin688.github.io/post/netdevops-gong-cheng-shi-jian-jiao-shou-jia-pian/">
        </link>
        <updated>2022-05-20T14:12:56.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæ¥æ‰‹å¤šä¸ªå¼€å‘é¡¹ç›®å¾€å¾€éƒ½ä¼šè®¾è®¡æ¯”è¾ƒå¤šé‡å¤çš„ä»£ç ç¼–å†™ï¼ŒåŒæ—¶ä¹Ÿä¼šæœ‰ä¸€äº›å¦‚ä½•å½¢æˆä¸€å¥—å·¥ç¨‹å®è·µçš„è„šæ‰‹æ¶ï¼Œä»¥æ¥</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[NetDevOps RestFrameworkåç«¯--FastAPIæ•™ç¨‹(2)]]></title>
        <id>https://wangxin688.github.io/post/netdevops-restframework-hou-duan-fastapi-jiao-cheng-2/</id>
        <link href="https://wangxin688.github.io/post/netdevops-restframework-hou-duan-fastapi-jiao-cheng-2/">
        </link>
        <updated>2022-05-20T13:44:48.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>å¼€å‘ä¹‹å‰å…ˆäº†è§£webæ¡†æ¶ä¸­å…³äºhttpéƒ¨åˆ†çš„åŸºç¡€æ¦‚å¿µï¼ŒæŸ¥æ¼è¡¥ç¼º</p>
</blockquote>
<h2 id="è·¯å¾„">è·¯å¾„</h2>
<p>å³ä¸€ä¸ªè¯¦ç»†çš„URLè·¯å¾„, å¦‚ <code>https://www.baidu.com/</code>, '127.0.0.1:800/api/v1/docs'</p>
<h3 id="è·¯å¾„å‚æ•°">è·¯å¾„å‚æ•°</h3>
<p>å¦‚urlä¸­éœ€è¦ä¼ å…¥å…·ä½“çš„å‚æ•°ï¼Œå¦‚å‰æ–‡ä¸­æåˆ°çš„{skills},</p>
<pre><code class="language-python">@app.get('/host/{hostname}')
def get_host(hostname: str):
    return {&quot;hostnam&quot;: hostname}
@app.get('/datacenter/{datacenter_name}')
def get_datacenter(datacenter_name: str):
    return {&quot;datacenter&quot;: datacenter_name}
</code></pre>
<h3 id="æŸ¥è¯¢å‚æ•°">æŸ¥è¯¢å‚æ•°</h3>
<p>ç»å¸¸çœ‹åˆ°<code>?limit=10&amp;offset=0</code></p>
<pre><code class="language-python">@app.get(&quot;/host/&quot;)
def get get_hosts(limit: Optional[int] = 10, offset: Optional[int]=0):
    return db_session.execute(select(Host).limit(limit).offset(offset).scalars().all()
</code></pre>
<h3 id="è¯·æ±‚ä½“">è¯·æ±‚ä½“</h3>
<p>å®¢æˆ·ç«¯å‘æ•°æ®ç»™æœåŠ¡å™¨ï¼Œæ•°æ®ä»¥è¯·æ±‚ä½“çš„å½¢å¼å‘é€ã€‚æœåŠ¡å™¨è¿”å›å“åº”ï¼Œä»¥å“åº”ä½“çš„å½¢å¼è¿”å›ã€‚<br>
é€šå¸¸è¯·æ±‚ä½“ä¸ç”¨getæ–¹å¼å‘é€ï¼Œåªèƒ½ä»¥postï¼Œputç­‰æ–¹å¼å‘é€ã€‚</p>
<pre><code class="language-python">from typing import Optional

from fastapi import FastAPI
from pydantic import BaseModel

class Host(BaseModel):
    hostname: str
    management_ip: str
    platform: str
    ssh_port: Optional[int] = 22

app = FastAPI()

@app.post('/host/')
def create_host(host: Host):
    return host

if __name__ == &quot;__main__&quot;:
    import uvicorn
    uvicorn.run(app, host='127.0.0.1', port=8080, debug=True)
</code></pre>
<p>æµ‹è¯•<br>
<img src="https://wangxin688.github.io/post-images/1653055898832.png" alt="" loading="lazy"></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[NetDevOps RestFrameworkåç«¯--FastAPIæ•™ç¨‹(1)]]></title>
        <id>https://wangxin688.github.io/post/netdevops-restframework-hou-duan-fastapi-jiao-cheng-1/</id>
        <link href="https://wangxin688.github.io/post/netdevops-restframework-hou-duan-fastapi-jiao-cheng-1/">
        </link>
        <updated>2022-05-19T15:26:06.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>å¼€å§‹å‰å¨å¨å‡ å¥ï¼Œåœ¨è¿›è¡Œwebåç«¯å¼€å‘çš„å‰æœŸï¼Œé¢ä¸´è¿‡æŠ€æœ¯æ¡†æ¶é€‰å‹çš„çº ç»“ï¼Œå‰é¢ä¸»è¦ä½¿ç”¨Djangoå’ŒFlaskåšæ¥å£å¼€å‘ã€‚Djangoä½œä¸ºæœ€æµè¡Œçš„python webæ¡†æ¶ä¹‹ä¸€ï¼Œç”Ÿæ€æä¸ºå®Œå–„ï¼Œç¤¾åŒºè½®å­ä¹Ÿéå¸¸å¤šï¼Œä½†æ˜¯æ¡†æ¶æœ¬èº«æ¯”è¾ƒç¬¨é‡ã€‚Flaskç»™ä¸äº†å¼€å‘è€…æå¤§çš„çµæ´»åº¦ï¼Œå­¦ä¹ é—¨æ§›ä¹Ÿæ¯”è¾ƒï¼Œå½“å‰ç¤¾åŒºç”Ÿæ€ä¹Ÿæ¯”è¾ƒå®Œå–„ã€‚<br>
ä½œä¸ºpython webæ¡†æ¶çš„æ–°è´µï¼ŒFastAPIé¢ä¸–çš„æ—¶é—´è¿‘4å¹´ï¼Œä¼˜é›…çš„è®¾è®¡(ç»™äºˆstarletteå’Œpydantic)å’Œé«˜æ€§èƒ½ä»ä¸€å¼€å§‹å°±å¸å¼•äº†æˆ‘ï¼Œæœ¬ç€å–œæ¬¢æŠ˜è…¾çš„æ€§æ ¼ï¼Œæœæ–­å…¥å‘äº†FastAPIã€‚</p>
</blockquote>
<h2 id="è¯´è¯´æˆ‘å½“å‰ä½¿ç”¨fastapiçš„å…³é”®ä¼˜åŠ¿ç‚¹">è¯´è¯´æˆ‘å½“å‰ä½¿ç”¨FastAPIçš„å…³é”®ä¼˜åŠ¿ç‚¹</h2>
<ul>
<li>High Performance: åŸºäºStarletteå’ŒPydantic, Starletteçš„ä½œè€…ä¹Ÿæ˜¯DRF(Django Restframework)çš„ä½œè€…ï¼Œæºç å†™çš„éå¸¸ä¼˜é›…ã€‚åŸºäºpydanticå¯ä»¥åšä¸¥æ ¼çš„æ•°æ®æ ¡éªŒï¼Œè¿™åœ¨webå¼€å‘å±‚é¢æä¾›äº†éå¸¸å¥½çš„çº¦æŸï¼Œé˜²æ­¢å„ç§éæ³•å‚æ•°å’Œç±»å‹è¾“å…¥</li>
<li>å…¥é—¨ç®€å•ï¼Œå­¦ä¹ æ›²çº¿æ¯”è¾ƒå¹³æ»‘ï¼ŒåŸºæœ¬å’Œflaskä¸€æ ·ï¼ŒDIYçš„ç©ºé—´éå¸¸å¤§ï¼ŒåŒæ—¶å…¥é—¨éå¸¸ç®€å•ï¼Œå¦‚æœå†™ä¸€ç‚¹æ¯”è¾ƒå°çš„æ¥å£éœ€æ±‚ï¼Œå¼€å‘æ•ˆç‡éå¸¸é«˜</li>
<li>è‡ªåŠ¨ç”ŸæˆOpenAPIæ–‡æ¡£</li>
<li>è‰¯å¥½çš„ä»£ç æç¤ºå’Œè‡ªåŠ¨è¡¥å…¨</li>
</ul>
<h2 id="demoå·¥ç¨‹">Demoå·¥ç¨‹</h2>
<h3 id="å¼€å‘ç¯å¢ƒå’ŒåŒ…å®‰è£…">å¼€å‘ç¯å¢ƒå’ŒåŒ…å®‰è£…</h3>
<pre><code>mkdir fastapi-demo  
poetry init  # åŸºäºpoetryçš„venv, ä¸€è·¯å›è½¦
poetry shell
poetry add fastapi, uvicorn  
</code></pre>
<h3 id="demopyç¼–å†™">demo.pyç¼–å†™</h3>
<p>æœ€ç®€çŸ­5è¡Œä»£ç å°±èƒ½å®ç°ä¸€ä¸ªAPIæ¥å£çš„ç¼–å†™ï¼Œæä¸ºè½»é‡, å…¥é—¨æ•™ç¨‹å¯ä»¥å‚è€ƒ<a href="https://fastapi.tiangolo.com/zh/">FastAPIå®˜ç½‘</a></p>
<pre><code class="language-python">from typing import Optional

from fastapi import FastAPI

app = FastAPI()

@app.get(&quot;/&quot;)
def hello():
    return {&quot;Hello&quot;: &quot;Network Engineer&quot;}

@app.get('/netops/{skills}')
def get_skills(skills: Optional[str]='python'):
    return {&quot;netops skills&quot;: skills}

if __name__ == &quot;__main__&quot;:
    import uvicorn
    uvicorn.run(app, host='localhost', port=8080, debug=True)
</code></pre>
<p>ä»£ç è¿è¡Œåæµè§ˆå™¨æ‰“å¼€http://127.0.0.1:8080/docsï¼Œå°±èƒ½çœ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„äº¤äº’å¼OpenAPIæ–‡æ¡£<br>
<img src="https://wangxin688.github.io/post-images/1652976245430.png" alt="" loading="lazy"></p>
<h3 id="å…³äºuvicron">å…³äºuvicron</h3>
<ul>
<li>åŸºäºuvloopå’Œhttptoolsæ„å»ºçš„ASGIæœåŠ¡å™¨ï¼Œé€Ÿåº¦éå¸¸å¿«ï¼Œå¦‚æœçº¯åç«¯ä¸æ¶‰åŠé™æ€æ–‡ä»¶ï¼Œç®€å•çš„åœºæ™¯å¯ä»¥æ— éœ€ä½¿ç”¨nginx</li>
<li>uvicronæœ¬èº«å¹¶ä¸æ˜¯webæ¡†æ¶ï¼Œè€Œæ˜¯ä¸€ä¸ªASGIçš„æœåŠ¡å™¨ï¼Œå¯¹åº”çš„æœ‰WSGI</li>
<li>starletteå’Œfastapiæ¨èä½¿ç”¨uvicronä½œä¸ºæœåŠ¡å™¨<br>
ä»¥å‘½ä»¤è¡Œå¯åŠ¨ç¤ºä¾‹</li>
</ul>
<pre><code>uvicorn demo:app --host 127.0.0.1 --port 8080 --reload 
# --hostæŒ‡å®šhost
# --portæŒ‡å®šç«¯å£
# --reload å¼€å¯debugæ¨¡å¼ï¼Œä»£ç å‘ç”Ÿå˜åŒ–ä¿å­˜æ—¶è‡ªåŠ¨é‡å¯app
# --log-level, è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œé»˜è®¤info(debug, info, warn....)
</code></pre>
<p>ä»‹ç»ä¸¤ä¸ªæ¯”è¾ƒç‰¹åˆ«çš„å‚æ•°ï¼Œä¸»è¦ç”¨LBåšä»£ç†è½¬å‘çš„åœºæ™¯ï¼ˆæµè§ˆå™¨X-forwardï¼‰ï¼Œéœ€è¦è·å–å®¢æˆ·ç«¯çœŸå®IPçš„åœºæ™¯<br>
--proxy-headers<br>
--forwarded-allow-ips</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Python ORM: SQLAlchemy 1.4/2.0æ•™ç¨‹]]></title>
        <id>https://wangxin688.github.io/post/sqlalchemy/</id>
        <link href="https://wangxin688.github.io/post/sqlalchemy/">
        </link>
        <updated>2022-05-19T15:10:39.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>å›½é™…æƒ¯ä¾‹å…ˆBBä¸‹ï¼š ä¸ºä»€ä¹ˆè¦ç”¨ORM? 1. ç®€å•çš„å°†å°±æ˜¯æƒ³å·æ‡’ï¼Œä¸æƒ³å†™sql  2. Pure python, å¯¹äºä¸€äº›ä¸å¤ªå¤æ‚çš„éœ€æ±‚ï¼ŒORMå®Œå…¨å¤Ÿç”¨ï¼Œç®€å•æ˜“æ‡‚ï¼ˆå°å£°BBï¼šCRUDèƒ½å¤æ‚åˆ°å“ªé‡Œå»ï¼Ÿï¼‰3. é¿å…sqlæ³¨å…¥æ”»å‡»</p>
</blockquote>
<h2 id="why-orm">Why ORM?</h2>
<p>ä¼˜ç‚¹</p>
<ul>
<li>é¢å‘å¯¹è±¡ï¼Œè¯­å¥æ¸…æ™°, pythonä¸­ä¸€ä¸ªç±»å¯¹åº”DBä¸€å¼ è¡¨</li>
<li>æ–¹ä¾¿åŠ¨æ€æ„é€ è¯­å¥ï¼Œå¯¹äºä¸åŒçš„è¡¨çš„ç›¸åŒæ“ä½œé‡‡ç”¨å¤šæ€å®ç°æ›´ä¼˜é›…</li>
<li>ä¸€å®šç¨‹åº¦æ–¹ä¾¿é‡æ„æ•°æ®å±‚ã€æ¯”å¦‚æ”¹è¡¨åï¼Œå­—æ®µåç­‰ã€</li>
<li>è®¾ç½®hookå‡½æ•°<br>
ç¼ºç‚¹</li>
<li>ä¸å¤ªå®¹æ˜“å¤„ç†å¤æ‚æŸ¥è¯¢è¯­å¥</li>
<li>æ€§èƒ½è¾ƒç›´æ¥ç”¨SQLå·®</li>
</ul>
<h2 id="python-ormæµè¡Œåº¦å’Œæ€§èƒ½å¯¹æ¯”">python ORMæµè¡Œåº¦å’Œæ€§èƒ½å¯¹æ¯”</h2>
<h3 id="1-sqlalchemy">1. <a href="https://github.com/sqlalchemy/sqlalchemy">sqlalchemy</a></h3>
<p>SQLAlchemy æ˜¯ Python ç”Ÿæ€ç³»ç»Ÿä¸­æœ€æµè¡Œçš„ ORMã€‚åŠŸèƒ½å¼ºå¤§é½å…¨ï¼ŒSQLAlchemy è®¾è®¡éå¸¸ä¼˜é›…ï¼Œåˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†â€”â€”åº•å±‚çš„ Core å’Œä¸Šå±‚çš„ä¼ ç»Ÿ ORMã€‚åœ¨ Python ä¹ƒè‡³å…¶ä»–è¯­è¨€çš„å¤§å¤šæ•° ORM ä¸­ï¼Œéƒ½æ²¡æœ‰å®ç°å¾ˆå¥½çš„åˆ†å±‚è®¾è®¡ï¼Œ æ¯”å¦‚ django çš„ ORMï¼Œæ•°æ®åº“é“¾æ¥å’Œ ORM æœ¬èº«å®Œå…¨æ··åœ¨ä¸€èµ·ã€‚</p>
<h3 id="2-tortoise-orm">2. <a href="https://github.com/coleifer/peewee">tortoise-orm</a></h3>
<p>å—djangoå¯å‘ï¼Œå¼‚æ­¥ç”Ÿæ€çš„ORMï¼Œæ¯”è¾ƒå¹´è½»çš„é¡¹ç›®</p>
<h3 id="3-peeweee">3. <a href="https://github.com/coleifer/peewee">peeweee</a></h3>
<p>ç®€å•æ˜“ç”¨çš„å°å‹ORMï¼Œæ˜“äºå­¦ä¹ ä¸ä½¿ç”¨</p>
<h3 id="4-sqlmodel">4. <a href="https://github.com/tiangolo/sqlmodel">sqlmodel</a></h3>
<p>FastAPIä½œè€…åŸºäºpydanticå’Œsqlalchemyæ„å»ºäº†sqlmodel, ç¬”è€…ä¹Ÿå°è¯•è¿›è¡Œäº†æ·±åº¦ä½¿ç”¨ï¼Œåœ¨ä½¿ç”¨ä¾¿åˆ©æ€§ï¼Œä»£ç æç¤ºå’Œè‡ªåŠ¨è¡¥å…¨æ–¹é¢æœ‰æ¯”è¾ƒå¤§çš„ä¼˜åŠ¿ï¼Œä½†å’Œalembicç»“åˆä»ç„¶æœ‰äº›bugä»¥åŠä¸€äº›featureç¼ºå¤±ï¼ŒåŒæ—¶æ–‡æ¡£å’Œç”Ÿæ€ä¸å¤Ÿå®Œå–„</p>
<h3 id="5-django-orm">5. django ORM</h3>
<p>djangoç”Ÿæ€ä¸­çš„è‡ªå¸¦ORM<br>
æœ€åè´´ä¸€å¼ æ€§èƒ½è·‘åˆ†<br>
<img src="https://wangxin688.github.io/post-images/1652973727220.png" alt="" loading="lazy"></p>
<h2 id="sqlalchemyæ¶æ„">SQLAlchemyæ¶æ„</h2>
<p><img src="https://wangxin688.github.io/post-images/1652973738464.png" alt="" loading="lazy"><br>
ç½‘ä¸Šå…³äºsqlalchemyçš„æ•™ç¨‹å¤§éƒ½æ˜¯åŸºäº1.3ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œæœ€æ–°çš„1.4ä»¥åŠåœ¨å¼€å‘ä¸­2.0ç‰ˆæœ¬æ•™ç¨‹å¾ˆå°‘ï¼Œæœ¬æ–‡åŸºäº1.4/2.0ç‰ˆæœ¬</p>
<h3 id="core">Core</h3>
<p>Coreå±‚ä¸»è¦å®ç°å®¢æˆ·ç«¯çš„è¿æ¥æ± ï¼ŒRDBMSé€šå¸¸ä¸é€‚ç”¨çŸ­è¿æ¥çš„æ–¹å¼ï¼Œå¤§éƒ½ä½¿ç”¨è¿æ¥æ± çš„æ–¹å¼æ¥è¿›è¡ŒDBè®¿é—®ã€‚</p>
<ul>
<li>å®¢æˆ·ç«¯è¿æ¥æ± ï¼šä½œä¸ºç¬¬ä¸‰æ–¹åº“å¼•å…¥ä»£ç ä¸­, å¦‚sqlalchemyçš„è¿æ¥æ± </li>
<li>æœåŠ¡ç«¯ï¼Œè¿æ¥æ± ä¸­é—´ä»¶ï¼Œç»™çŸ­è¿æ¥æ¯æ¬¡åˆ†é…ä¸€ä¸ªé•¿é“¾æ¥å¤ç”¨</li>
</ul>
<h2 id="20-æ•™ç¨‹">2.0 æ•™ç¨‹</h2>
<blockquote>
<p>å‰é¢BBäº†è¿™ä¹ˆå¤šè¿›å…¥æ­£é¢˜<br>
æ¶‰åŠç±»å®¹ï¼šåˆ›å»ºå¯¹è±¡-&gt;å»ºç«‹è¿æ¥æ± -&gt;äº‹åŠ¡-&gt;å¤–é”®ï¼ˆä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤šï¼‰-&gt; CRUD-&gt;alembicç‰ˆæœ¬ç®¡ç†-&gt;å¼‚æ­¥</p>
</blockquote>
<h3 id="åˆ›å»ºå¯¹è±¡">åˆ›å»ºå¯¹è±¡</h3>
<pre><code class="language-python"># models.py
from typing import Any, Cast
from datetime import datetime
from sqlalchemy import Integer, Column, String, func, Text, Binary
from sqlalchemy.orm import declarative_base, relationship, deferred

Base = cast(Any, declarative_base())

class Site(Base):
    __tablename__ = &quot;network_sites&quot;
    id = Column(Integer, primary_key=True)
    site_code = Column(String(30), unique=True, nullable=False, index=True)
    site_name = Column(String(30))
    status = Column(String)
    # defferdå…³é”®è¯ï¼Œå»¶è¿Ÿåˆ—åŠ è½½å…è®¸ä»…åœ¨ç›´æ¥è®¿é—®æ—¶åŠ è½½è¡¨çš„ç‰¹å®šåˆ—ï¼Œè€Œä¸æ˜¯åœ¨ä½¿ç”¨æŸ¥è¯¢å®ä½“æ—¶åŠ è½½ Queryã€‚å¦‚æœè¦é¿å…åœ¨ä¸éœ€è¦æ—¶å°†å¤§å‹æ–‡æœ¬æˆ–äºŒè¿›åˆ¶å­—æ®µåŠ è½½åˆ°å†…å­˜ä¸­æ—¶ï¼Œâ€
    description = deferred(Column(Text))
    # å­˜å‚¨äºŒè¿›åˆ¶çš„å›¾ç‰‡
    topology = deffered(Column(Binary))
    # é»˜è®¤å€¼ï¼Œæ³¨æ„ä¼ é€’çš„æ˜¯å‡½æ•°ï¼Œä¸æ˜¯ç°åœ¨çš„æ—¶é—´
    created_at = Column(DateTime(Timezone=True), default=datetime.now)
    # æˆ–è€…ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤å€¼ï¼Œä½†æ˜¯å¿…é¡»åœ¨è¡¨åˆ›å»ºçš„æ—¶å€™å°±è®¾ç½®å¥½ï¼Œä¼šæˆä¸ºè¡¨çš„ schema çš„ä¸€éƒ¨åˆ†
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    # å¯¹è±¡æ›´æ–°æ—¶å€™è‡ªåŠ¨ä¿®æ”¹update_timeä¸ºå½“å‰æ—¶é—´
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    # å¤–é”®åšåå‘æŸ¥è¯¢å¼•ç”¨æ”¯æŒbackrefå’Œback_populateä¸¤ç§æ–¹å¼ï¼Œbackrefåªéœ€è¦çˆ¶ç±»å£°æ˜ï¼Œback_populateéœ€è¦åœ¨ä¸¤ä¸ªç±»åŒæ—¶å£°æ˜ï¼Œä¸ºäº†æ›´åŠ ç¬¦åˆpythonicçš„å†™æ³•ï¼Œé‡‡ç”¨æ˜¾ç¤ºå£°æ˜çš„æ–¹å¼åœ¨ä¸¤ä¸ªç±»åŒæ—¶å®šä¹‰
    hosts = relationship('Host', back_populate='network_sites', on_delete='all, cascade')
    
    # åŸå§‹æŸ¥è¯¢è¿”å›æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯è¯»æ€§è¾ƒå·®ï¼Œä½¿ç”¨__repr__æ–¹æ³•æ›¿æ¢åç§°
    def __repr__(self):
        return f'Site: {site_code}-{site_name}'
    
    # åºåˆ—åŒ–tupleå¯¹è±¡ä¸ºdict
    @property
    def serialize(self):
        return {
            &quot;id&quot;: self.id,
            &quot;site_code&quot;: self.site_code,
            &quot;site_name&quot;: self.site_name,
            &quot;description&quot;: self.description,
            &quot;topology&quot;: self.topology,
            &quot;create_at&quot;: self.create_at,
            &quot;update_at&quot;: self.update_at,
        }

class Host(Base):
     __tablename__ = &quot;network_sites&quot;
    id = Column(Integer, primary_key=True)
    hostname = Column(String(30), unique=True, nullable=False, index=True)
    management_ip = Column(String(30), comment=&quot;ç®¡ç†IP&quot;)
    device_type = Column(String(30))
    manufacture = Column(String)
    description = deferred(Column(Text)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    # å¯¹è±¡æ›´æ–°æ—¶å€™è‡ªåŠ¨ä¿®æ”¹update_timeä¸ºå½“å‰æ—¶é—´
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    site_id = Column(Integer, ForeignKey('network_sites.id', ondelete=&quot;CASCADE&quot;))
    site = relationship('Site', back_populate='network_sites', overlaps='network_sites')

    def __str__(self):
        return f'Host: {hostname}'

# å¤šå¯¹å¤šæ¨¡å‹éœ€è¦åˆ›å»ºä¸€ä¸ªå…³è”è¡¨
# å…³è”è¡¨
class UserPermissions(Base):
    __tablename__ = 'user_permissions'
    id = Column(Integer, primary_key=True)
    # åŒæ ·ç”¨ foreign key æŒ‡å®šå¤–é”®
    user_id = Column(Integer, ForeignKey('users.id'))
    permission_id = Column(String, ForeignKey('permissions.id'))

class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    # ä½¿ç”¨ secondary æŒ‡å®šå…³è”è¡¨ï¼ŒåŒæ ·ç”¨ overlaps æŒ‡å®šå¯¹åº”æ¨¡å‹ä¸­çš„å­—æ®µ
    permissions = relationship('Permission', secondary=&quot;user_permissions&quot;, overlaps=&quot;users&quot;)

class Permission(Base):
    __tablename__ = 'permissions'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    # åŒä¸Š
    users = relationship('User', secondary=&quot;user_permissions&quot;, overlaps=&quot;permissions&quot;)
å¤åˆ¶ä»£ç 
</code></pre>
<h3 id="åˆ›å»ºè¿æ¥æ± ">åˆ›å»ºè¿æ¥æ± </h3>
<pre><code class="language-python"># db_session.py
from sqlalchemy import create_engine
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine
from sqlalchemy.orm.session import sessionmaker

async_sqlalchemy_database_uri =&quot;postgresql+asyncpg://user:password@localhost/netdevops&quot;
# å¼‚æ­¥æ•°æ®åº“è¿æ¥æ± ä¼šè¯
async_engine = create_async_engine(async_sqlalchemy_database_uri, pool_pre_ping=True)
async_session = sessionmaker(async_engine, expire_on_commit=False, class_=AsyncSession)

sqlalchemy_database_uri = create_engine(&quot;sqlite:///:memory:&quot;, echo=True, future=True)
# åŒæ­¥æ•°æ®åº“è¿æ¥æ± ï¼Œ Sessionä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œwebæ¡†æ¶éœ€è¦åœ¨æ¯ä¸ªè¯·æ±‚å¼€å§‹è·å–ä¸€ä¸ªsession
engine = create_engine(sqlalchemy_database_uri, pool_pre_ping=True)
new_session = sessionmaker(engine, expire_on_commit=False)
å¤åˆ¶ä»£ç 
</code></pre>
<h3 id="åˆ›å»ºæ•°æ®åº“è¡¨å’Œcrud">åˆ›å»ºæ•°æ®åº“è¡¨å’ŒCRUD</h3>
<pre><code class="language-python"># create_table.py
from .models import Site,Host,User,Permission
from .db_session import engine, new_session

# è°ƒç”¨ create_all åˆ›å»ºæ‰€æœ‰æ¨¡å‹
Base.metadata.create_all(engine)

# å¦‚æœåªéœ€è¦åˆ›å»ºä¸€ä¸ªæ¨¡å‹
User.__table__.create(engine)

# CRUD, session ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œweb æ¡†æ¶åº”è¯¥åœ¨æ¯ä¸ªè¯·æ±‚å¼€å§‹æ—¶è·å–ä¸€ä¸ª sessionï¼Œ æ‰€ä»¥ä¹Ÿä¸æ˜¯é—®é¢˜ã€‚
with Session(engine) as session:
    session.add(foo)
    session.commit()

# è¿˜å¯ä»¥ä½¿ç”¨ sessionmaker æ¥åˆ›å»ºä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡éƒ½è¾“å…¥å‚æ•°äº†

from sqlachemy.orm import sessionmaker
new_session = sessionmaker(engine)

with new_session() as session:
    ...
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[NetDevOpså¼€å‘ç¯å¢ƒç¯‡]]></title>
        <id>https://wangxin688.github.io/post/devlopment-env/</id>
        <link href="https://wangxin688.github.io/post/devlopment-env/">
        </link>
        <updated>2022-05-19T15:01:55.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨ï¼Œä¸€ä¸ªé«˜æ•ˆå’Œé«˜é¢œå€¼çš„IDEï¼Œè®©ä½ ç¼–å†™ä»£ç çš„æ—¶éƒ½æ˜¯èµå¿ƒæ‚¦ç›®çš„æ„Ÿè§‰ğŸ˜ã€‚é¢œç‹—æœç„¶æ˜¯é¢œç‹—</p>
</blockquote>
<h2 id="1-èƒŒæ™¯">1. èƒŒæ™¯</h2>
<p>åœ¨ä½¿ç”¨pythonä½œä¸ºå¼€å‘è¯­è¨€çš„è¿‘ä¸¤å¹´æ—¶é—´ï¼Œç»å†ç”±windows-&gt;macosç¯å¢ƒåˆ‡æ¢ç„¶ålinuxéƒ¨ç½²ä»£ç ï¼Œæ¥å›çš„ç¯å¢ƒåˆ‡æ¢ä»¥åŠä»£ç è°ƒè¯•éƒ½å¸¦äº†æå¤§ä¸ä¾¿ï¼Œpycharmè™½ç„¶æ¨å‡ºäº†è¿œç¨‹å¼€å‘ç¯å¢ƒJB Gatewayï¼Œä½†æ˜¯å½“å‰ç‰ˆæœ¬ä½“éªŒæ‰æ€¥ï¼Œbugä¹Ÿéå¸¸å¤šã€‚2022å¹´åˆåœ¨ä½¿ç”¨vscodeçš„è¿‡ç¨‹ä¸­æ— æ„å‘ç°vscodeä¹Ÿæ”¯æŒè¿œç¨‹å¼€å‘ï¼Œä¸€ç»ä½¿ç”¨ä¾¿ä¸€å‘ä¸å¯æ”¶æ‹¾ï¼Œå½»åº•çˆ±ä¸Švscode, ä¹Ÿç”±æ­¤å®Œå…¨æŠ›å¼ƒäº†pycharmå¼€å§‹ä½¿ç”¨vscodeä½œä¸ºå¼€å‘IDE.<br>
vscodeå¯ä»¥ç›´æ¥è¿æ¥åˆ°è¿œç¨‹å¼€å‘æœºä¸Šè¿›è¡Œå¼€å‘ï¼Œvscodeç¤¾åŒºä¸°å¯Œçš„æ’ä»¶ä¹Ÿå¯ä»¥ç›´æ¥å®‰è£…å’Œè¿è¡Œåœ¨å¼€å‘æœºä¸­ï¼Œå› æ­¤åœ¨åŸç”Ÿçš„linuxç¯å¢ƒä¸­è¿›è¡Œä»£ç ç¼–å†™å’Œè°ƒè¯•ï¼Œå¯¹äºä¸ªäººé¡¹ç›®æ¥è¯´ï¼Œä»ç¼–ç -&gt;æµ‹è¯•-&gt;è°ƒè¯•-&gt;ä¸Šçº¿å¯ä»¥ä¸€æ¡é¾™è§£å†³ï¼Œå¤§å¹…åº¦æå‡å¼€å‘æ•ˆç‡å’Œä½“éªŒ</p>
<h2 id="2-å¼€å‘æœºç¯å¢ƒæ­å»º">2. å¼€å‘æœºç¯å¢ƒæ­å»º</h2>
<blockquote>
<p>Linux devboxç¯‡ï¼Œå¼ºçƒˆæ¨è<br>
system: debian11, å¹²å‡€çš„è™šæœºç¯å¢ƒ<br>
pythonç‰ˆæœ¬ï¼š^3.9.2</p>
</blockquote>
<h3 id="devbox-setup">devbox setup</h3>
<ul>
<li>åˆ‡æ¢aptæº,æ¨èä½¿ç”¨é˜¿é‡Œæº</li>
</ul>
<pre><code class="language-shell">$ sudo cat &lt;&lt;EOF &gt;/etc/apt/source.list
&gt; deb http://mirrors.aliyun.com/debian/ bullseye main non-free contrib
&gt; deb-src http://mirrors.aliyun.com/debian/ bullseye main non-free contrib
&gt; deb http://mirrors.aliyun.com/debian-security/ bullseye-security main
&gt; deb-src http://mirrors.aliyun.com/debian-security/ bullseye-security main
&gt; deb http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib
&gt; deb-src http://mirrors.aliyun.com/debian/ bullseye-updates main non-free &gt; contrib
&gt; deb http://mirrors.aliyun.com/debian/ bullseye-backports main non-free contrib
&gt; deb-src http://mirrors.aliyun.com/debian/ bullseye-backports main non-free contrib
&gt; EOF
$ sudo apt update
</code></pre>
<ul>
<li>install pip3</li>
</ul>
<pre><code>$sudo apt install python3-pip
</code></pre>
<p>intall git</p>
<pre><code>$ sudo apt install git
</code></pre>
<ul>
<li>install virtual evn, ä¸ªäººååˆ†æ¨èä½¿ç”¨poetryä½œä¸ºpythonçš„virtualenv</li>
</ul>
<pre><code>$ pip3 install poetry( or pip3 install virtualenv)
</code></pre>
<ul>
<li>install docker-ce, docker-composeï¼Œæ–¹ä¾¿å¿«é€Ÿå¯åŠ¨æœåŠ¡æå‡å¼€å‘é€Ÿåº¦</li>
</ul>
<pre><code class="language-shell">$ sudo apt-get update
$ sudo apt-get install \
   ca-certificates \
   curl \
   gnupg \
   lsb-release
$ curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

$ echo \
 &quot;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \
 $(lsb_release -cs) stable&quot; | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
$ sudo chmod a+r /usr/share/keyrings/docker-archive-keyring.gpg

$ sudo apt-get update
$ sudo apt-get install docker-ce docker-ce-cli containerd.io


$ sudo curl -L &quot;https://github.com/docker/compose/releases/download/v2.2.3/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose

$ sudo chmod 755 /usr/local/bin/docker-compose
</code></pre>
<ul>
<li>ç¡®è®¤dockerä»¥åŠpoetryç¯å¢ƒæ˜¯å¦ready</li>
</ul>
<pre><code class="language-shell">$ which poetry
$ which docker-compose
$ sudo docker ps
</code></pre>
<p>åˆ°æ­¤ï¼Œå¼€å‘æœºåŸºç¡€ç¯å¢ƒå°±å·²ç»okäº†ã€‚</p>
<h3 id="vscodeæ’ä»¶å®‰è£…">VSCodeæ’ä»¶å®‰è£…</h3>
<ol>
<li>Remote Developmentï¼Œç”¨äºvscodeè¿œç¨‹è¿æ¥åˆ°devboxçš„linuxç¯å¢ƒ</li>
<li>Python</li>
<li>Code Runner, ç”¨äºvscodeç›´æ¥è¿è¡Œpythonä»£ç </li>
<li>autoDocstring,è‡ªåŠ¨ç”Ÿæˆæ ‡å‡†åŒ–çš„æ³¨é‡Š</li>
<li>Jinjaï¼Œå†™é…ç½®æ¨¡æ¿å¿…å¤‡</li>
<li>YAML</li>
<li>Tabline, ä»£ç AIè¡¥å…¨å·¥å…·</li>
<li>Atom One Dark Pro, é¢œå€¼å³æ­£ä¹‰</li>
</ol>
<h4 id="ç•ªå¤–ç¯‡vscodeè®¾ç½®ç¯‡">ç•ªå¤–ç¯‡ï¼Œvscodeè®¾ç½®ç¯‡</h4>
<ol>
<li>å­—ä½“æ¨èï¼šSource Code Pro, Monoca, å‡ºé—¨å·¦è½¬githubï¼Œwindowsä¸‹è½½rttæ–‡ä»¶å®‰è£…ã€‚settings: font.editorè®¾ç½®ä»»æ„å­—ä½“ä¹‹ä¸€</li>
<li>è‡ªåŠ¨ä¿å­˜: settings: autosave on focus change</li>
<li>æ–‡ä»¶æ˜¾ç¤ºè¿‡æ»¤ï¼š settings: exclued, æ–°å¢**/<strong>pycache</strong>, ç§»é™¤ä¸€å¤§æ¨çƒ¦äººçš„pycæ–‡ä»¶</li>
</ol>
]]></content>
    </entry>
</feed>